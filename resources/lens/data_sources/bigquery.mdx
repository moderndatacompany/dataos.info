---
title: "Bigquery"
---

## Prerequisites

* an active bigquery depot.

While creating a semantic model on bigquery source, the following aspects need to be considered:

### **1. Prepare the Lens model folder**

Start by setting up the **Lens Model Folder**

```
model
├── sqls
│   └── sample.sql  # SQL script for table dimensions
├── tables
│   └── sample_table.yml  # Logical table definition (joins, dimensions, measures, segments)
├── views
│   └── sample_view.yml  # Logical views referencing tables
└── user_groups.yml  # User group policies for governance
```

1. **SQL Scripts (`model/sqls`)**

   * Add SQL files defining table structures and transformations.

   * Ensure the SQL dialect matches BigQuery syntax. Format table names as:
     `project_id.dataset.table`

   * Use `STRING` for text data types instead of `VARCHAR`.

   * Replace generic functions with BigQuery's `EXTRACT` function.

2. **Tables (`model/tables`)**

   * Define logical tables in separate YAML files. Include dimensions, measures, segments, and joins.

3. **Views (`model/views`)**

   * Define views in YAML files, referencing the logical tables.

4. **User Groups (`user_groups.yml`)**

   * Define access control by creating user groups and assigning permissions.

### **2. BigQuery Depot manifest template file**

Below is a template for configuring the BigQuery Depot:

```yaml
name: ${{depot-name}}
version: v1
type: depot
tags:
  - ${{dropzone}}
  - ${{bigquery}}
owner: ${{owner-name}}
layer: user
depot: # mandatory
  type: BIGQUERY  # mandatory               
  description: ${{description}} # optional
  external: ${{true}} # mandatory
  connectionSecret:            
    - acl: rw
      type: key-value-properties
      data:
        projectid: ${{project-name}}
        email: ${{email-id}}
      files:
        json_keyfile: ${{json-file-path}}
    - acl: r
      type: key-value-properties
      data:
        projectid: ${{project-name}}
        email: ${{email-id}}
      files:
        json_keyfile: ${{json-file-path}}
  spec:  # optional                         
    project: ${{project-name}} # optional
    params: # optional
      ${{"key1": "value1"}}
      ${{"key2": "value2"}}
```

### 3. Deployment manifest file

After setting up the Lens model folder, the next step is to configure the **deployment manifest**. This involves:

* **Defining the Source:**

  * **Source type:**  The `type` attribute in the `source` section must be explicitly set to `depot`.

  * **Source name:** The `name` attribute in the `source` section should specify the name of the Bigquery Depot created .

* **Setting Up Compute and Secrets:**

  * Define the compute settings, such as which engine (e.g., `runnable-default`) will process the data.

  * Include any necessary secrets (e.g., credentials for Bitbucket or AWS) for secure access to data and repositories.

* **Defining Repository:**

  * &#x20; **Repo name:** The `url` attribute in the repo section specifies the Git repository where the Lens model files are stored. For instance, if your repo name is lensTutorial then the repo `url` will be  [https://bitbucket.org/tmdc/lensTutorial](https://bitbucket.org/tmdc/lensTutorial)

    * **Lens directory name:**  The `lensBaseDir` attribute refers to the directory in the repository containing the Lens model. Example: `sample/lens/source/depot/bigquery/model`.

    * **Secret id:**  The `secretId` attribute is used to access private repositories (e.g., Bitbucket, GitHub) . It specifies the secret needed to securely authenticate and access the repository.

    * SyncFlags:  Specifies additional flags to control repository synchronization. Example: `--ref=dev` specifies that the Lens model rsides in the dev branch.&#x20;

* **Configuring API and Worker Settings (Optional):** Set up replicas, logging levels, and resource allocations for APIs, workers, routers, and other components.

After configuring the deployment file with the necessary settings and specifications, use the following sample YAML as a template to guide your Lens deployment.

```yaml
version: v1alpha
name: "bigquery-lens"
layer: user
type: lens
tags:
  - lens
description: bigquery depot lens deployment on lens2
lens:
  compute: runnable-default
  secrets:
    - name: bitbucket-cred
      allKeys: true
  source:
    type: depot # source type is depot here
    name: bigquerydepot # name of the bigquery depot
 
  repo:
    url: https://bitbucket.org/tmdc/sample
    lensBaseDir: sample/lens/source/depot/bigquery/model 
    # secretId: lens2_bitbucket_r
    syncFlags:
      - --ref=lens

  api:   # optional
    replicas: 1 # optional
    logLevel: info  # optional
      
    resources: # optional
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 2000m
        memory: 2048Mi
  worker: # optional
    replicas: 2 # optional
    logLevel: debug  # optional
    resources: # optional
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 6000m
        memory: 6048Mi
        
  router: # optional
    logLevel: info  # optional
    resources: # optional
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 6000m
        memory: 6048Mi
  iris:
    logLevel: info  
    resources: # optional
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 6000m
        memory: 6048Mi
```

## Docker compose manifest file

Ensure that highlighted attributes are in the Docker Compose Manifest file for proper configuration during the connection setup process.

<Accordion title="click here to see docker compose manifest file" defaultOpen={false}>
  ```
  version: "2.2"

  x-lens2-environment: &lens2-environment
    # DataOS
    DATAOS_FQDN: liberal-monkey.dataos.app
    # Overview
    LENS2_NAME: sales360
    LENS2_DESCRIPTION: "Ecommerce use case on Adventureworks sales data"
    LENS2_TAGS: "lens2, ecom, sales and customer insights"
    LENS2_AUTHORS: "rakeshvishvakarma, shubhanshu"
    LENS2_SCHEDULED_REFRESH_TIMEZONES: "UTC,America/Vancouver,America/Toronto"
    # Data Source
    LENS2_SOURCE_TYPE: ${depot} #source name - depot
    LENS2_SOURCE_NAME: ${bigquerydepot} #name of the bigquery depot
    DATAOS_RUN_AS_APIKEY: ${A1ZjMDliZTFhZWJhMQ==}
    # LogZjAtNDY4My05
    LENS2_LOG_LEVEL: error
    CACHE_LOG_LEVEL: "trace"
    # Operation
    LENS2_DEV_MODE: true
    LENS2_DEV_MODE_PLAYGROUND: false
    LENS2_REFRESH_WORKER: true
    LENS2_SCHEMA_PATH: model
    LENS2_PG_SQL_PORT: 5432
    CACHE_DATA_DIR: "/var/work/.store"
    NODE_ENV: production
    LENS2_ALLOW_UNGROUPED_WITHOUT_PRIMARY_KEY: "true"
  services:
    api:
      restart: always
      image: rubiklabs/lens2:0.35.41-05
      ports:
        - 4000:4000
        - 25432:5432
        - 13306:13306
      environment:
        <<: *lens2-environment   
      volumes:
        - ./model:/etc/dataos/work/model
        # - ./scripts/commons.js:/app/scripts/commons.js
        # - ./scripts/bootstrap.js:/app/scripts/bootstrap.js
        # - ./scripts/config.js:/app/scripts/config.js
  ```
</Accordion>